<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT Backend Tester</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .full { grid-column: span 2; }
        input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; margin-top: 10px; }
        pre { background: #1e1e1e; color: #dcdcdc; padding: 15px; border-radius: 8px; overflow-x: auto; font-family: 'Courier New', monospace; }
        .token-status { font-size: 0.8em; margin-bottom: 10px; padding: 5px; border-radius: 4px; }
        .active { background: #d4edda; color: #155724; }
        .inactive { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    <div class="card full">
        <h2>Auth Status</h2>
        <div id="tokenIndicator" class="token-status inactive">No Access Token Found</div>
        <button onclick="clearAuth()" class="btn-secondary" style="width: auto;">Clear Local Storage (Log out UI)</button>
    </div>

    <div class="card">
        <h3>Register</h3>
        <form id="regForm">
            <input type="text" name="first_name" placeholder="First Name" required>
            <input type="text" name="last_name" placeholder="Last Name" required>
            <input type="email" name="email" placeholder="Email" required>
            <input type="password" name="password" placeholder="Password (min 8)" required>
            <button type="submit" class="btn-primary">Register</button>
        </form>
    </div>

    <div class="card">
        <h3>Login</h3>
        <form id="loginForm">
            <input type="email" name="email" placeholder="Email" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit" class="btn-primary">Login</button>
        </form>
    </div>

    <div class="card full">
        <h3>Test Endpoints</h3>
        <div style="display: flex; gap: 10px;">
            <button onclick="fetchData('/')" class="btn-primary">Get Home (Protected)</button>
            <button onclick="fetchData('/logout')" class="btn-secondary">Logout (Protected)</button>
        </div>
        <h4>Response:</h4>
        <pre id="output">Submit a form to see results...</pre>
    </div>
</div>

<script>
    const output = document.getElementById('output');
const tokenIndicator = document.getElementById('tokenIndicator');

// 1. Centralized Logging Function
function renderOutput(path, status, data) {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = {
        time: timestamp,
        endpoint: path,
        http_status: status,
        response: data
    };
    
    // Prepend the new log so the latest is always on top
    output.textContent = JSON.stringify(logEntry, null, 2);
    console.log("UI Updated:", logEntry);
}

// 2. Updated API Request with better parsing
async function apiRequest(method, path, body = null) {
    const headers = { 'Content-Type': 'application/json' };
    const token = localStorage.getItem('access_token');
    
    if (token) headers['Authorization'] = `Bearer ${token}`;

    try {
        let response = await fetch(path, {
            method,
            headers,
            body: body ? JSON.stringify(body) : null,
            credentials: 'include'
        });

        // Handle Token Expiration & Refresh
        if (response.status === 401 && path !== '/login' && path !== '/refresh') {
            console.warn("401 detected, refreshing...");
            const refreshRes = await fetch('/refresh', { method: 'POST', credentials: 'include' });
            
            if (refreshRes.ok) {
                const refreshData = await refreshRes.json();
                const newToken = refreshData.token || refreshData.access_token;
                
                if (newToken) {
                    localStorage.setItem('access_token', newToken);
                    updateTokenUI();
                    
                    // Retry original request
                    headers['Authorization'] = `Bearer ${newToken}`;
                    response = await fetch(path, {
                        method,
                        headers,
                        body: body ? JSON.stringify(body) : null,
                        credentials: 'include'
                    });
                }
            } else {
                localStorage.removeItem('access_token');
                updateTokenUI();
                renderOutput(path, 401, "Session Expired - Please Login Again");
                return;
            }
        }

        // SMART PARSING: Handle JSON vs Plain Text
        const contentType = response.headers.get("content-type");
        let responseData;
        if (contentType && contentType.includes("application/json")) {
            responseData = await response.json();
        } else {
            responseData = await response.text();
        }

        // UPDATE THE UI
        renderOutput(path, response.status, responseData);
        return { status: response.status, data: responseData };

    } catch (err) {
        renderOutput(path, "Client Error", err.message);
    }
}

// 3. Form Handlers
document.getElementById('regForm').onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    await apiRequest('POST', '/register', Object.fromEntries(fd));
};

document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await apiRequest('POST', '/login', Object.fromEntries(fd));
    
    if (res && res.status === 200 && res.data.token) {
        localStorage.setItem('access_token', res.data.token);
        updateTokenUI();
    }
};

async function fetchData(path) {
    await apiRequest('GET', path);
}

function updateTokenUI() {
    const token = localStorage.getItem('access_token');
    if (token) {
        tokenIndicator.textContent = "Access Token Active";
        tokenIndicator.className = "token-status active";
    } else {
        tokenIndicator.textContent = "No Access Token";
        tokenIndicator.className = "token-status inactive";
    }
}

updateTokenUI();
</script>
</body>
</html>